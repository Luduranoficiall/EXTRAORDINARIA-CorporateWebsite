<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Iframe Preview - test sender</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 16px; }
      iframe { width: 100%; height: 60vh; border: 1px solid #ddd; }
      .controls { margin-top: 12px; }
    </style>
  </head>
  <body>
    <h1>Iframe Preview</h1>
    <p>This page embeds the app inside an iframe and performs the <code>iframe-init</code> handshake.</p>
    <iframe id="appFrame" src="/" title="App preview"></iframe>

    <div class="controls">
      <button id="initBtn">Send iframe-init (with MessageChannel)</button>
      <button id="initSimple">Send simple iframe-init (no channel)</button>
      <pre id="log"></pre>
    </div>

    <script>
      const log = (msg) => { const el = document.getElementById('log'); el.textContent += msg + '\n'; };
      const iframe = document.getElementById('appFrame');

      document.getElementById('initBtn').addEventListener('click', () => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => log('port1 received: ' + JSON.stringify(e.data));

        const payload = {
          type: 'iframe-init',
          previewIframeInitialOptions: { env: 'preview', ts: Date.now() },
          initScriptURL: null,
          initScriptBlob: null
        };

        iframe.contentWindow.postMessage(payload, '*', [channel.port2]);
        log('iframe-init sent with MessageChannel');
      });

      document.getElementById('initSimple').addEventListener('click', () => {
        const payload = { type: 'iframe-init', previewIframeInitialOptions: { env: 'simple' } };
        iframe.contentWindow.postMessage(payload, '*');
        log('iframe-init sent (simple)');
      });
    </script>
  </body>
</html>
